<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>实验室器材管理系统</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">实验室器材管理系统（共享数据库版）</h2>

    <!-- 表单 -->
    <form id="itemForm" class="row g-3 mb-4">
      <div class="col-md-2"><input type="date" class="form-control" name="time" required></div>
      <div class="col-md-2"><input type="text" class="form-control" name="name" placeholder="元件名称" required></div>
      <div class="col-md-2"><input type="text" class="form-control" name="model" placeholder="型号"></div>
      <div class="col-md-2"><input type="text" class="form-control" name="param" placeholder="主要参数"></div>
      <div class="col-md-2"><input type="text" class="form-control" name="factory" placeholder="厂家"></div>
      <div class="col-md-1"><input type="number" class="form-control" name="price" placeholder="单价" required></div>
      <div class="col-md-1"><input type="number" class="form-control" name="count" placeholder="数量" required></div>
      <div class="col-md-2"><input type="text" class="form-control" name="person" placeholder="办理人"></div>
      <div class="col-md-2"><input type="text" class="form-control" name="location" placeholder="存放地点"></div>
      <div class="col-md-2"><input type="text" class="form-control" name="note" placeholder="备注"></div>
      <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">添加</button></div>
    </form>

    <!-- 搜索 -->
    <div class="mb-3">
      <input id="searchBox" type="text" class="form-control" placeholder="搜索器材...">
    </div>

    <!-- 表格 -->
    <table class="table table-striped">
      <thead>
        <tr>
          <th>采购时间</th><th>元件名称</th><th>型号</th><th>主要参数</th>
          <th>厂家</th><th>单价</th><th>数量</th><th>总价</th>
          <th>办理人</th><th>存放地点</th><th>备注</th><th>操作</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

<script>
const SUPABASE_URL = "https://nsrrcrrbtwvtuvmtifdu.supabase.co";  // ← 替换
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zcnJjcnJidHd2dHV2bXRpZmR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyOTMzMzEsImV4cCI6MjA3MTg2OTMzMX0.bDvJ1uUoXUD__YSGLIZ6INC7NQ0BP0YFSwTDS1nC7J8";     // ← 替换
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const form = document.getElementById("itemForm");
const tableBody = document.getElementById("tableBody");
const searchBox = document.getElementById("searchBox");

async function loadItems() {
  let { data, error } = await supabase.from("items").select("*").order("id", { ascending: false });
  if (error) { alert("加载失败：" + error.message); return; }

  const keyword = searchBox.value.trim().toLowerCase();
  tableBody.innerHTML = "";
  data.forEach(item => {
    if (!keyword || JSON.stringify(item).toLowerCase().includes(keyword)) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.time || ""}</td>
        <td>${item.name || ""}</td>
        <td>${item.model || ""}</td>
        <td>${item.param || ""}</td>
        <td>${item.factory || ""}</td>
        <td>${item.price || ""}</td>
        <td>${item.count || ""}</td>
        <td>${(item.price * item.count).toFixed(2)}</td>
        <td>${item.person || ""}</td>
        <td>${item.location || ""}</td>
        <td>${item.note || ""}</td>
        <td><button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})">删除</button></td>
      `;
      tableBody.appendChild(tr);
    }
  });
}

form.addEventListener("submit", async e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(form).entries());
  data.price = parseFloat(data.price);
  data.count = parseInt(data.count);

  const { error } = await supabase.from("items").insert([data]);
  if (error) { alert("保存失败：" + error.message); return; }

  form.reset();
  await loadItems();
});

async function deleteItem(id) {
  if (!confirm("确定删除该记录吗？")) return;
  const { error } = await supabase.from("items").delete().eq("id", id);
  if (error) { alert("删除失败：" + error.message); return; }
  await loadItems();
}

searchBox.addEventListener("input", loadItems);

// 初次加载
loadItems();
</script>
</body>
</html>
